<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Banco de Horas - Usina</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
}
header{
  background:#1e7e34;
  color:#fff;
  padding:15px;
  text-align:center;
}
.container{
  max-width:1000px;
  margin:20px auto;
  background:#fff;
  padding:20px;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.1);
}
input,select,button{
  padding:8px;
  margin:5px 0;
  width:100%;
  border-radius:4px;
  border:1px solid #ccc;
  text-transform: uppercase;
  box-sizing:border-box;
}
button{
  background:#1e7e34;
  color:#fff;
  border:none;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
  font-size:14px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}
th{
  background:#1e7e34;
  color:#fff;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
  gap:10px;
}
.hidden{display:none;}
.table-wrapper{overflow-x:auto;}
</style>
</head>

<body>

<header>
<h1>Sistema de Banco de Horas</h1>
</header>

<div class="container" id="consultaBox">
<h2>Consulta</h2>
<input id="consultaNome" placeholder="Digite seu nome">
<button onclick="consultar()">Consultar</button>
<p id="resultado"></p>
<hr>
<button onclick="abrirLogin()">Área Administrativa</button>
</div>

<div class="container hidden" id="loginBox">
<h2>Login Admin</h2>
<input id="email" placeholder="Email">
<input id="senha" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
</div>

<div class="container hidden" id="app">
<h2>Lançamento</h2>

<div style="display:flex; align-items:center; margin-bottom:10px;">
  <button onclick="voltarConsulta()" style="background:none;border:none;font-size:18px;cursor:pointer;color:#1e7e34;">← Voltar</button>
</div>

<div class="grid">
<input id="nome" placeholder="Colaborador">
<select id="tipo">
<option>Crédito</option>
<option>Débito</option>
</select>
<input type="date" id="data">
<input type="time" id="entrada">
<input type="time" id="saida">
<input id="horasDebito" placeholder="Horas (somente Débito)" class="hidden">
<input id="motivo" placeholder="Motivo">
</div>

<p id="saldoAtual"></p>
<button onclick="salvar()">Salvar</button>

<input id="pdfNome" placeholder="Digite o nome do colaborador para PDF">
<button onclick="gerarPDF()">Gerar PDF do Colaborador</button>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Nome</th><th>Tipo</th><th>Data</th><th>Entrada</th><th>Saída</th><th>Horas</th><th>Saldo</th><th>Motivo</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const SUPABASE_URL = "https://vsfuqtxgcklnarbwhgsg.supabase.co";
const SUPABASE_KEY = "sb_publishable_RNmE9Ov_erkSCqN2n7FWIQ_oTRX1rrO";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

window.abrirLogin = () => {
  consultaBox.classList.add('hidden');
  loginBox.classList.remove('hidden');
}

window.login = async () => {
  const { error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: senha.value
  });
  if(error) return alert("Erro no login");
  loginBox.classList.add('hidden');
  app.classList.remove('hidden');
  carregar();
}

function formatarHora(decimal){
  const totalMin = Math.round(decimal * 60);
  const h = Math.floor(totalMin / 60);
  const m = totalMin % 60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}

async function mostrarSaldo(nomeBusca){
  const { data } = await supabase.from("banco_horas")
    .select("*").ilike("nome", `%${nomeBusca}%`);

  if(!data || data.length===0){ saldoAtual.innerText="Nenhum registro encontrado"; return 0; }

  let saldoMin=0;
  data.forEach(r=>{
    saldoMin += r.tipo==="Crédito" ? r.horas*60 : -r.horas*60;
  });

  saldoAtual.innerText =
  `${data[0].nome} | Saldo atual do colaborador: ${formatarHora(saldoMin/60)}`;

  return saldoMin/60;
}

window.salvar = async () => {
  if(!nome.value.trim()) return alert("Digite o nome do colaborador");

  let horas=0, entradaVal=entrada.value||null, saidaVal=saida.value||null;

  if(tipo.value==="Crédito"){
    horas=(new Date(`1970-01-01T${saida.value}`)-new Date(`1970-01-01T${entrada.value}`))/3600000;
    if(horas<=0) return alert("Digite horários válidos para Crédito");
  } else {
    horas=parseFloat(horasDebito.value);
    if(isNaN(horas) || horas<=0) return alert("Digite uma quantidade válida de horas para Débito");
    const saldoAtualCalc=await mostrarSaldo(nome.value.trim());
    if(horas>saldoAtualCalc) return alert(`Saldo insuficiente! O colaborador tem apenas ${formatarHora(saldoAtualCalc)}`);
    entradaVal=null; saidaVal=null;
  }

  await supabase.from("banco_horas").insert([{
    nome:nome.value.trim(), tipo:tipo.value, data:data.value,
    entrada:entradaVal, saida:saidaVal,
    horas:Number(horas.toFixed(4)), motivo:motivo.value.trim()
  }]);

  carregar();
}

window.consultar = async () => {
  const nomeBusca=consultaNome.value.trim();
  if(!nomeBusca){ resultado.innerText="Digite um nome para consulta."; return; }

  const { data } = await supabase.from("banco_horas")
    .select("*").ilike("nome", `%${nomeBusca}%`);

  if(!data || data.length===0){ resultado.innerText="Nenhum registro encontrado."; return; }

  let saldoMin=0;
  data.forEach(r=>{
    saldoMin += r.tipo==="Crédito" ? r.horas*60 : -r.horas*60;
  });

  resultado.innerText = `Colaborador: ${data[0].nome} | Saldo: ${formatarHora(saldoMin/60)}`;
}

async function carregar(){
  const { data } = await supabase.from("banco_horas").select("*").order("data",{ascending:true});
  lista.innerHTML="";
  let saldos={};

  data.forEach(r=>{
    if(!saldos[r.nome]) saldos[r.nome]=0;
    saldos[r.nome]+= r.tipo==="Crédito"? r.horas*60 : -r.horas*60;

    lista.innerHTML+=`
    <tr>
      <td>${r.nome}</td><td>${r.tipo}</td><td>${r.data}</td>
      <td>${r.entrada||''}</td><td>${r.saida||''}</td>
      <td>${formatarHora(r.horas)}</td>
      <td>${formatarHora(saldos[r.nome]/60)}</td>
      <td>${r.motivo}</td>
    </tr>`;
  });
}

window.voltarConsulta = function(){
  app.classList.add('hidden');        
  loginBox.classList.add('hidden');   
  consultaBox.classList.remove('hidden'); 
}

window.gerarPDF = async () => {
  const nomeBusca = pdfNome.value.trim();
  if(!nomeBusca) return alert("Digite o nome do colaborador");

  const { data } = await supabase
    .from("banco_horas")
    .select("*")
    .ilike("nome", `%${nomeBusca}%`)
    .order("data",{ascending:true});

  if(!data || data.length===0){
    alert("Nenhum registro encontrado para este colaborador.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 10;
  doc.setFontSize(12);
  doc.text(`Banco de Horas - ${data[0].nome}`, 10, y);
  y += 10;

  let saldoMin = 0;

  data.forEach(r => {
    saldoMin += r.tipo === "Crédito" ? r.horas*60 : -r.horas*60;

    const linha = [
      r.data,
      r.tipo,
      r.entrada || "",
      r.saida || "",
      formatarHora(r.horas),
      formatarHora(saldoMin/60),
      r.motivo || ""
    ].join(" | ");

    if(y > 280){
      doc.addPage();
      y = 10;
    }

    doc.setFontSize(9);
    doc.text(linha, 10, y);
    y += 6;
  });

  doc.save(`Banco_Horas_${data[0].nome}.pdf`);
};
</script>

</body>
</html>
