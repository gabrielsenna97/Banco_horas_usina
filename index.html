<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Banco de Horas - Usina</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
}
header{
  background:#1e7e34;
  color:#fff;
  padding:15px;
  text-align:center;
}
.container{
  max-width:1000px;
  margin:20px auto;
  background:#fff;
  padding:20px;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.1);
}
input,select,button{
  padding:8px;
  margin:5px 0;
  width:100%;
  border-radius:4px;
  border:1px solid #ccc;
  text-transform: uppercase; /* força maiúsculas */
  box-sizing:border-box;
}
button{
  background:#1e7e34;
  color:#fff;
  border:none;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
  font-size:14px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
  white-space: nowrap;
}
th{
  background:#1e7e34;
  color:#fff;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
  gap:10px;
}
.hidden{display:none;}
.table-wrapper{
  overflow-x:auto;
}

/* RESPONSIVO PARA CELULAR */
@media (max-width: 600px){
  header h1{
    font-size:18px;
  }
  .grid{
    grid-template-columns:1fr;
  }
  table, th, td{
    font-size:12px;
    white-space: normal;
  }
  button{
    font-size:14px;
    padding:6px;
  }
  p#saldoAtual{
    font-size:14px;
  }
  input, select{
    font-size:14px;
  }
}
</style>
</head>

<body>

<header>
<h1>Sistema de Banco de Horas</h1>
</header>

<div class="container" id="consultaBox">
<h2>Consulta</h2>
<input id="consultaNome" placeholder="Digite seu nome">
<button onclick="consultar()">Consultar</button>
<p id="resultado"></p>
<hr>
<button onclick="abrirLogin()">Área Administrativa</button>
</div>

<div class="container hidden" id="loginBox">
<h2>Login Admin</h2>
<input id="email" placeholder="Email">
<input id="senha" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
</div>

<div class="container hidden" id="app">
<h2>Lançamento</h2>

<div style="display:flex; align-items:center; margin-bottom:10px;">
  <button onclick="voltarConsulta()" style="
    background:none; 
    border:none; 
    font-size:18px; 
    cursor:pointer; 
    color:#1e7e34;
    display:flex;
    align-items:center;
    gap:5px;
    padding:0;
  ">
    ← Voltar
  </button>
</div>

<div class="grid">
<input id="nome" placeholder="Colaborador">
<select id="tipo">
<option>Crédito</option>
<option>Débito</option>
</select>
<input type="date" id="data">
<input type="time" id="entrada">
<input type="time" id="saida">
<input id="horasDebito" placeholder="Horas (somente Débito)" class="hidden">
<input id="motivo" placeholder="Motivo">
</div>

<p id="saldoAtual"></p>
<button onclick="salvar()">Salvar</button>

<input id="pdfNome" placeholder="Digite o nome do colaborador para PDF">
<button onclick="gerarPDF()">Gerar PDF do Colaborador</button>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Nome</th><th>Tipo</th><th>Data</th><th>Entrada</th><th>Saída</th><th>Horas</th><th>Saldo</th><th>Motivo</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://vsfuqtxgcklnarbwhgsg.supabase.co";
const SUPABASE_KEY = "sb_publishable_RNmE9Ov_erkSCqN2n7FWIQ_oTRX1rrO";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

window.abrirLogin = () => {
  consultaBox.classList.add('hidden');
  loginBox.classList.remove('hidden');
}

window.login = async () => {
  const { error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: senha.value
  });
  if(error) return alert("Erro no login");
  loginBox.classList.add('hidden');
  app.classList.remove('hidden');
  carregar();
}

document.querySelectorAll('input[type="text"], input[type="search"]').forEach(input => {
  input.addEventListener('input', () => {
    input.value = input.value.toUpperCase();
  });
});

tipo.addEventListener("change", async () => {
  if(tipo.value === "Débito"){
    horasDebito.classList.remove("hidden");
    entrada.classList.add("hidden");
    saida.classList.add("hidden");
  } else {
    horasDebito.classList.add("hidden");
    entrada.classList.remove("hidden");
    saida.classList.remove("hidden");
  }
  if(nome.value.trim()!==""){
    await mostrarSaldo(nome.value.trim());
  }
});

nome.addEventListener("input", async () => {
  if(nome.value.trim()!==""){
    await mostrarSaldo(nome.value.trim());
  } else {
    saldoAtual.innerText = "";
  }
});

async function mostrarSaldo(nomeBusca){
  const { data, error } = await supabase
    .from("banco_horas")
    .select("*")
    .ilike("nome", `%${nomeBusca}%`);

  if(error || !data || data.length === 0){
    saldoAtual.innerText = "Nenhum registro encontrado.";
    return 0;
  }

  let saldo = 0;
  data.forEach(r=>{
    saldo += r.tipo === "Crédito" ? Number(r.horas) : -Number(r.horas);
  });

  saldoAtual.innerText = `${data[0].nome} | Saldo atual: ${saldo.toFixed(2)}h`;
  return saldo;
}

window.salvar = async () => {
  if(!nome.value.trim()) return alert("Digite o nome do colaborador");
  let horas=0, entradaVal=entrada.value||null, saidaVal=saida.value||null;

  if(tipo.value==="Crédito"){
    horas=(new Date(`1970-01-01T${saida.value}`)-new Date(`1970-01-01T${entrada.value}`))/3600000;
    if(horas<=0) return alert("Digite horários válidos para Crédito");
  } else {
    horas=parseFloat(horasDebito.value);
    if(isNaN(horas)||horas<=0) return alert("Digite horas válidas");
    const saldoAtualCalc = await mostrarSaldo(nome.value.trim());
    if(horas>saldoAtualCalc) return alert(`Saldo insuficiente! Apenas ${saldoAtualCalc.toFixed(2)}h`);
    entradaVal=null; saidaVal=null;
  }

  await supabase.from("banco_horas").insert([{
    nome:nome.value.trim(),
    tipo:tipo.value,
    data:data.value,
    entrada:entradaVal,
    saida:saidaVal,
    horas:Number(horas.toFixed(2)),
    motivo:motivo.value.trim()
  }]);

  carregar();
  horasDebito.value=""; saldoAtual.innerText="";
}

window.consultar=async()=>{
  const nomeBusca=consultaNome.value.trim();
  if(!nomeBusca){resultado.innerText="Digite um nome"; return;}
  const { data, error } = await supabase.from("banco_horas").select("*").ilike("nome", `%${nomeBusca}%`);
  if(error){alert("Erro"); return;}
  if(!data||data.length===0){resultado.innerText="Nenhum registro"; return;}
  let saldo=0;
  data.forEach(r=>{saldo+=r.tipo==="Crédito"?Number(r.horas):-Number(r.horas)});
  resultado.innerText=`Colaborador: ${data[0].nome} | Saldo: ${saldo.toFixed(2)}h`;
}

async function carregar(){
  const { data } = await supabase.from("banco_horas").select("*").order("data",{ascending:true});
  lista.innerHTML=""; let saldos={};
  data.forEach(r=>{
    if(!saldos[r.nome]) saldos[r.nome]=0;
    saldos[r.nome]+=r.tipo==="Crédito"?r.horas:-r.horas;
    lista.innerHTML+=`
    <tr>
      <td>${r.nome}</td><td>${r.tipo}</td><td>${r.data}</td><td>${r.entrada||''}</td><td>${r.saida||''}</td><td>${r.horas}</td><td>${saldos[r.nome].toFixed(2)}</td><td>${r.motivo}</td>
    </tr>`;
  });
}

window.voltarConsulta = function(){
  app.classList.add('hidden');        
  loginBox.classList.add('hidden');   
  consultaBox.classList.remove('hidden'); 
}

// GERAR PDF PROFISSIONAL
window.gerarPDF = async () => {
  const colaborador=document.getElementById("pdfNome").value.trim();
  if(!colaborador) return alert("Digite o nome");

  const { data, error } = await supabase.from("banco_horas")
    .select("*").ilike("nome", `%${colaborador}%`).order("data",{ascending:true});

  if(error || !data || data.length===0) return alert("Nenhum registro encontrado");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const margin=40, pageWidth=595;
  let y=margin;

  // Cabeçalho
  doc.setFontSize(18);
  doc.text("Relatório Banco de Horas", pageWidth/2, y, {align:"center"});
  y+=30;
  doc.setFontSize(12);
  doc.text(`Colaborador: ${data[0].nome}`, margin, y);
  y+=20;

  // Linha separadora
  doc.setLineWidth(1);
  doc.line(margin,y,pageWidth-margin,y);
  y+=10;

  // Cabeçalho tabela
  const headers=["Data","Tipo","Entrada","Saída","Horas","Saldo","Motivo"];
  const colX=[margin,100,160,220,280,340,400];
  headers.forEach((h,i)=>doc.text(h,colX[i],y));
  y+=10;
  doc.setLineWidth(0.5);
  doc.line(margin,y,pageWidth-margin,y);
  y+=10;

  // Dados
  let saldoAcumulado=0;
  data.forEach(r=>{
    saldoAcumulado+=r.tipo==="Crédito"?r.horas:-r.horas;
    const row=[r.data,r.tipo,r.entrada||'',r.saida||'',r.horas.toString(),saldoAcumulado.toFixed(2),r.motivo||''];
    row.forEach((txt,i)=>doc.text(txt,colX[i],y));
    y+=20;
    if(y>750){ doc.addPage(); y=margin; }
  });

  doc.save(`${colaborador}_BancoHoras.pdf`);
}
</script>
</body>
</html>
