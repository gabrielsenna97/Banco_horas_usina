<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Banco de Horas - Usina</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
}
header{
  background:#1e7e34;
  color:#fff;
  padding:15px;
  text-align:center;
}
.container{
  max-width:1000px;
  margin:20px auto;
  background:#fff;
  padding:20px;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.1);
}
input,select,button{
  padding:8px;
  margin:5px 0;
  width:100%;
  border-radius:4px;
  border:1px solid #ccc;
  text-transform: uppercase;
  box-sizing:border-box;
}
button{
  background:#1e7e34;
  color:#fff;
  border:none;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
  font-size:14px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}
th{
  background:#1e7e34;
  color:#fff;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
  gap:10px;
}
.hidden{display:none;}
.table-wrapper{
  overflow-x:auto;
}

/* RESPONSIVO PARA CELULAR */
@media (max-width: 600px){
  header h1{
    font-size:18px;
  }
  .grid{
    grid-template-columns:1fr;
  }
  table, th, td{
    font-size:12px;
  }
  button{
    font-size:14px;
    padding:6px;
  }
  p#saldoAtual{
    font-size:14px;
  }
  input, select{
    font-size:14px;
  }
}
</style>
</head>

<body>

<header>
<h1>Sistema de Banco de Horas</h1>
</header>

<!-- TELA DE CONSULTA -->
<div class="container" id="consultaBox">
<h2>Consulta</h2>
<input id="consultaNome" placeholder="Digite seu nome">
<button onclick="consultar()">Consultar</button>
<p id="resultado"></p>
<hr>
<button onclick="abrirLogin()">Área Administrativa</button>
</div>

<!-- LOGIN -->
<div class="container hidden" id="loginBox">
<h2>Login Admin</h2>
<input id="email" placeholder="Email">
<input id="senha" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
</div>

<!-- ÁREA ADMINISTRATIVA -->
<div class="container hidden" id="app">
<h2>Lançamento</h2>

<div style="display:flex; align-items:center; margin-bottom:10px;">
  <button onclick="voltarConsulta()" style="
    background:none; 
    border:none; 
    font-size:18px; 
    cursor:pointer; 
    color:#1e7e34;
    display:flex;
    align-items:center;
    gap:5px;
    padding:0;
  ">
    ← Voltar
  </button>
</div>

<div class="grid">
<input id="nome" placeholder="Colaborador">
<select id="tipo">
<option>Crédito</option>
<option>Débito</option>
</select>
<input type="date" id="data">
<input type="time" id="entrada">
<input type="time" id="saida">
<input id="horasDebito" placeholder="Horas (somente Débito)" class="hidden">
<input id="motivo" placeholder="Motivo">
</div>

<p id="saldoAtual"></p>
<button onclick="salvar()">Salvar</button>

<!-- PDF -->
<input id="pdfNome" placeholder="Digite o nome do colaborador para PDF">
<button onclick="gerarPDF()">Gerar PDF do Colaborador</button>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Nome</th><th>Tipo</th><th>Data</th><th>Entrada</th><th>Saída</th><th>Horas</th><th>Saldo</th><th>Motivo</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>
</div>
</div>

<!-- JS PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const SUPABASE_URL = "https://vsfuqtxgcklnarbwhgsg.supabase.co";
const SUPABASE_KEY = "sb_publishable_RNmE9Ov_erkSCqN2n7FWIQ_oTRX1rrO";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// ABRIR LOGIN
window.abrirLogin = () => {
  consultaBox.classList.add('hidden');
  loginBox.classList.remove('hidden');
}

// LOGIN
window.login = async () => {
  const { error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: senha.value
  });
  if(error) return alert("Erro no login");
  loginBox.classList.add('hidden');
  app.classList.remove('hidden');
  carregar();
}

// FORÇAR MAIÚSCULAS
document.querySelectorAll('input[type="text"], input[type="search"]').forEach(input => {
  input.addEventListener('input', () => { input.value = input.value.toUpperCase(); });
});

// MOSTRAR/HIDE DÉBITO
tipo.addEventListener("change", async () => {
  if(tipo.value === "Débito"){
    horasDebito.classList.remove("hidden");
    entrada.classList.add("hidden");
    saida.classList.add("hidden");
  } else {
    horasDebito.classList.add("hidden");
    entrada.classList.remove("hidden");
    saida.classList.remove("hidden");
  }
  if(nome.value.trim()!=="") await mostrarSaldo(nome.value.trim());
});

// MOSTRAR SALDO AO DIGITAR NOME
nome.addEventListener("input", async () => {
  if(nome.value.trim()!=="") await mostrarSaldo(nome.value.trim());
  else saldoAtual.innerText = "";
});

// FUNÇÃO PARA CALCULAR HORAS EM HH:MM
function calcularHoras(entrada, saida){
  const diff = (new Date(`1970-01-01T${saida}`) - new Date(`1970-01-01T${entrada}`)) / 1000; // segundos
  const horas = Math.floor(diff / 3600);
  const minutos = Math.floor((diff % 3600) / 60);
  return `${String(horas).padStart(2,'0')}:${String(minutos).padStart(2,'0')}`;
}

// FUNÇÃO SALDO
async function mostrarSaldo(nomeBusca){
  const { data, error } = await supabase.from("banco_horas")
    .select("*").ilike("nome", `%${nomeBusca}%`);
  if(error || !data || data.length===0){ saldoAtual.innerText="Nenhum registro encontrado"; return 0; }
  let saldoSegundos=0;
  data.forEach(r=>{
    const [h,m] = r.horas.split(':').map(Number);
    saldoSegundos += r.tipo==="Crédito"? (h*3600 + m*60) : -(h*3600 + m*60);
  });
  const saldoHoras = Math.floor(saldoSegundos/3600);
  const saldoMinutos = Math.floor((saldoSegundos%3600)/60);
  saldoAtual.innerText = `${data[0].nome} | Saldo atual do colaborador: ${String(saldoHoras).padStart(2,'0')}:${String(saldoMinutos).padStart(2,'0')}`;
  return saldoSegundos;
}

// SALVAR
window.salvar = async () => {
  if(!nome.value.trim()) return alert("Digite o nome do colaborador");

  let horasVal="", entradaVal=entrada.value||null, saidaVal=saida.value||null;
  if(tipo.value==="Crédito"){
    if(!entrada.value || !saida.value) return alert("Digite entrada e saída válidas");
    horasVal = calcularHoras(entrada.value, saida.value);
  } else {
    if(!horasDebito.value) return alert("Digite quantidade de horas para débito");
    const [h,m] = horasDebito.value.split(':').map(Number);
    if(isNaN(h)) return alert("Horas inválidas");
    horasVal = `${String(h).padStart(2,'0')}:${String(m||0).padStart(2,'0')}`;
    const saldoAtualCalc = await mostrarSaldo(nome.value.trim());
    const totalSegundosDebito = h*3600 + (m||0)*60;
    if(totalSegundosDebito > saldoAtualCalc) return alert("Saldo insuficiente!");
    entradaVal=null; saidaVal=null;
  }

  await supabase.from("banco_horas").insert([{
    nome:nome.value.trim(),
    tipo:tipo.value,
    data:data.value,
    entrada:entradaVal,
    saida:saidaVal,
    horas:horasVal,
    motivo:motivo.value.trim()
  }]);
  carregar(); horasDebito.value=""; saldoAtual.innerText="";
}

// CONSULTA
window.consultar = async () => {
  const nomeBusca=consultaNome.value.trim();
  if(!nomeBusca){ resultado.innerText="Digite um nome para consulta."; return; }
  const { data, error } = await supabase.from("banco_horas")
    .select("*").ilike("nome", `%${nomeBusca}%`);
  if(error){ alert("Erro na consulta"); console.log(error); return; }
  if(!data || data.length===0){ resultado.innerText="Nenhum registro encontrado."; return; }
  let saldoSegundos=0;
  data.forEach(r=>{
    const [h,m] = r.horas.split(':').map(Number);
    saldoSegundos += r.tipo==="Crédito"? (h*3600 + m*60) : -(h*3600 + m*60);
  });
  const saldoHoras = Math.floor(saldoSegundos/3600);
  const saldoMinutos = Math.floor((saldoSegundos%3600)/60);
  resultado.innerText = `Colaborador: ${data[0].nome} | Saldo: ${String(saldoHoras).padStart(2,'0')}:${String(saldoMinutos).padStart(2,'0')}`;
}

// CARREGAR TABELA
async function carregar(){
  const { data } = await supabase.from("banco_horas").select("*").order("data",{ascending:true});
  lista.innerHTML="";
  let saldosSegundos={};
  data.forEach(r=>{
    if(!saldosSegundos[r.nome]) saldosSegundos[r.nome]=0;
    const [h,m] = r.horas.split(':').map(Number);
    const totalSegundos = h*3600 + (m||0)*60;
    saldosSegundos[r.nome] += r.tipo==="Crédito"?totalSegundos:-totalSegundos;
    const saldoHoras = Math.floor(saldosSegundos[r.nome]/3600);
    const saldoMinutos = Math.floor((saldosSegundos[r.nome]%3600)/60);
    lista.innerHTML += `
      <tr>
        <td>${r.nome}</td><td>${r.tipo}</td><td>${r.data}</td>
        <td>${r.entrada||''}</td><td>${r.saida||''}</td>
        <td>${r.horas}</td><td>${String(saldoHoras).padStart(2,'0')}:${String(saldoMinutos).padStart(2,'0')}</td><td>${r.motivo}</td>
      </tr>
    `;
  });
}

// VOLTAR PARA CONSULTA
window.voltarConsulta = function(){
  app.classList.add('hidden');        
  loginBox.classList.add('hidden');   
  consultaBox.classList.remove('hidden'); 
}

// GERAR PDF PROFISSIONAL
window.gerarPDF = async () => {
  const colaborador=document.getElementById("pdfNome").value.trim();
  if(!colaborador) return alert("Digite o nome do colaborador");
  const { data, error } = await supabase.from("banco_horas")
    .select("*").ilike("nome", `%${colaborador}%`).order("data",{ascending:true});
  if(error || !data || data.length===0) return alert("Nenhum registro encontrado");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const margin=40, pageWidth=595, rowHeight=20;
  let y=margin;

  // Cabeçalho
  doc.setFillColor(30,126,52);
  doc.rect(0,0,pageWidth,50,'F');
  doc.setFontSize(20); doc.setTextColor(255,255,255);
  doc.text("Relatório de Banco de Horas", pageWidth/2,30,{align:"center"});

  // Info colaborador
  doc.setFontSize(12); doc.setTextColor(0,0,0);
  y+=60; doc.text(`Colaborador: ${data[0].nome}`, margin, y); y+=25;

  // Cabeçalho tabela
  const headers=["Data","Tipo","Entrada","Saída","Horas","Saldo","Motivo"];
  const colX=[margin,110,180,250,320,380,450];
  doc.setFontSize(10); doc.setFillColor(200,200,200);
  doc.rect(margin-2,y-rowHeight+4,pageWidth-margin*2+4,rowHeight,'F');
  headers.forEach((h,i)=>doc.text(h,colX[i],y));
  y+=rowHeight;

  // Dados tabela
  let saldoAcumuladoSegundos=0;
  data.forEach((r,index)=>{
    if(y>750){ doc.addPage(); y=margin+20; }
    const [h,m] = r.horas.split(':').map(Number);
    const totalSegundos = h*3600 + (m||0)*60;
    saldoAcumuladoSegundos += r.tipo==="Crédito"?totalSegundos:-totalSegundos;
    const saldoHoras = Math.floor(saldoAcumuladoSegundos/3600);
    const saldoMinutos = Math.floor((saldoAcumuladoSegundos%3600)/60);

    doc.setFillColor(index%2===0?245:255, index%2===0?245:255, index%2===0?245:255);
    doc.rect(margin-2,y-rowHeight+4,pageWidth-margin*2+4,rowHeight,'F');

    const row=[r.data,r.tipo,r.entrada||'',r.saida||'',r.horas,`${String(saldoHoras).padStart(2,'0')}:${String(saldoMinutos).padStart(2,'0')}`,r.motivo||''];
    row.forEach((txt,i)=>doc.text(txt.toString(),colX[i],y));
    y+=rowHeight;
  });

  y+=10;
  const totalSaldoHoras = Math.floor(saldoAcumuladoSegundos/3600);
  const totalSaldoMin = Math.floor((saldoAcumuladoSegundos%3600)/60);
  doc.setFontSize(12); doc.setTextColor(30,126,52);
  doc.text(`Saldo Total: ${String(totalSaldoHoras).padStart(2,'0')}:${String(totalSaldoMin).padStart(2,'0')}`, margin, y);

  doc.save(`${colaborador}_BancoHoras.pdf`);
}
</script>

</body>
</html>
